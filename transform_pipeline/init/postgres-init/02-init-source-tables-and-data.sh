#!/bin/bash

set -e
set -u

# Заполняем БД SOURCE_POSTGRES_DATABASE
if [ -n "$SOURCE_POSTGRES_DATABASE" ] && [ -n "$SOURCE_POSTGRES_TABLE" ]; then
    echo "Creating table ${SOURCE_POSTGRES_TABLE} in ${SOURCE_POSTGRES_DATABASE}"
    psql -v ON_ERROR_STOP=1 --username "$SOURCE_POSTGRES_USER" --dbname "$SOURCE_POSTGRES_DATABASE" >/dev/null <<-EOSQL
      \c $SOURCE_POSTGRES_DATABASE;
      DROP TABLE IF EXISTS $SOURCE_POSTGRES_TABLE;

      -- Таблица клиентов с "грязными" тестовыми данными
      CREATE TABLE IF NOT EXISTS $SOURCE_POSTGRES_TABLE (
          customer_id VARCHAR(255),
          first_name VARCHAR(255),
          last_name VARCHAR(255),
          email VARCHAR(255),
          phone VARCHAR(50),
          registration_date VARCHAR(50),  -- намеренно VARCHAR вместо DATETIME
          last_purchase_date VARCHAR(50),
          total_purchases VARCHAR(50),    -- намеренно VARCHAR вместо INTEGER
          total_amount_spent VARCHAR(50), -- намеренно VARCHAR вместо DECIMAL
          age VARCHAR(50),                -- намеренно VARCHAR вместо INTEGER
          city VARCHAR(255),
          country VARCHAR(255),
          created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
      );

      -- ЗАПОЛНЕНИЕ "ГРЯЗНЫМИ" ТЕСТОВЫМИ ДАННЫМИ
      -- Данные содержат типичные проблемы качества:
          -- Дубликаты (полные и частичные)
          -- Пропущенные значения (NULL)
          -- Невалидные email адреса
          -- Разные форматы телефонов
          -- Разные форматы дат
          -- Опечатки и лишние пробелы
          -- Невалидные возрасты
          -- Отрицательные значения
          -- Смешанные типы данных

      INSERT INTO $SOURCE_POSTGRES_TABLE (customer_id, first_name, last_name, email, phone, 
                                registration_date, last_purchase_date, total_purchases, 
                                total_amount_spent, age, city, country) VALUES

      -- Нормальные записи
      ('CUST001', 'Иван', 'Петров', 'ivan.petrov@mail.ru', '+7-999-123-4567', '2023-01-15', '2024-11-20', '15', '45000.50', '35', 'Москва', 'Россия'),
      ('CUST002', 'Мария', 'Сидорова', 'maria.sidorova@gmail.com', '8(916)234-5678', '15/02/2023', '2024-12-01', '8', '22000', '28', 'Санкт-Петербург', 'Россия'),
      ('CUST003', 'Алексей', 'Козлов', 'alexey.kozlov@yandex.ru', '79161234567', '2023-03-10', '2024-11-25', '22', '78000.75', '42', 'Новосибирск', 'Россия'),

      -- ПРОБЛЕМА: Дубликаты (полные)
      ('CUST004', 'Елена', 'Смирнова', 'elena.smirnova@mail.ru', '+7-999-876-5432', '2023-04-05', '2024-10-15', '5', '15000', '31', 'Казань', 'Россия'),
      ('CUST004', 'Елена', 'Смирнова', 'elena.smirnova@mail.ru', '+7-999-876-5432', '2023-04-05', '2024-10-15', '5', '15000', '31', 'Казань', 'Россия'),

      -- ПРОБЛЕМА: Частичные дубликаты (один email, разные ID)
      ('CUST005', 'Дмитрий', 'Волков', 'dmitry@gmail.com', '+7-925-111-2233', '2023-05-20', '2024-12-10', '12', '35000', '29', 'Екатеринбург', 'Россия'),
      ('CUST006', 'Дмитрий', 'Волков', 'dmitry@gmail.com', '8-925-111-22-33', '2023-05-20', '2024-12-10', '12', '35000', '29', 'Екатеринбург', 'Россия'),

      -- ПРОБЛЕМА: NULL значения
      ('CUST007', 'Анна', 'Морозова', NULL, '+7-903-555-6677', '2023-06-15', '2024-11-30', '3', '8500', '26', 'Ростов-на-Дону', 'Россия'),
      ('CUST008', 'Сергей', NULL, 'sergey.ivanov@mail.ru', NULL, '2023-07-01', NULL, '0', '0', '33', NULL, 'Россия'),
      ('CUST009', NULL, 'Кузнецов', 'kuzn@yandex.ru', '+7-916-777-8899', NULL, '2024-11-15', '7', '18000', NULL, 'Уфа', 'Россия'),

      -- ПРОБЛЕМА: Невалидные email
      ('CUST010', 'Ольга', 'Павлова', 'olga.pavlova', '+7-999-333-4455', '2023-08-10', '2024-12-05', '9', '25000', '37', 'Самара', 'Россия'),
      ('CUST011', 'Виктор', 'Николаев', 'viktor@', '79993334455', '2023-08-15', '2024-11-28', '4', '12000', '45', 'Омск', 'Россия'),
      ('CUST012', 'Татьяна', 'Лебедева', '@mail.ru', '+7(916)444-5566', '2023-09-01', '2024-10-20', '2', '5500', '52', 'Краснодар', 'Россия'),

      -- ПРОБЛЕМА: Лишние пробелы и опечатки
      ('CUST013', '  Михаил  ', 'Соколов', 'mikhail.sokolov@gmail.com  ', '+7-925-666-7788', '2023-09-20', '2024-12-15', '18', '52000', '39', '  Воронеж  ', 'Россия'),
      ('CUST014', 'Наталья', 'Новикова  ', '  natalia.novikova@yandex.ru', '8  916  777  8899', '2023-10-05', '2024-11-22', '6', '19000', '34', 'Пермь', 'Россия  '),

      -- ПРОБЛЕМА: Разные форматы дат
      ('CUST015', 'Павел', 'Морозов', 'pavel.morozov@mail.ru', '+7-903-888-9900', '20.10.2023', '01.12.2024', '11', '31000', '41', 'Волгоград', 'Россия'),
      ('CUST016', 'Юлия', 'Захарова', 'julia.zakharova@gmail.com', '+7-916-999-0011', '2023/11/15', '2024/12/08', '13', '38000', '30', 'Саратов', 'Россия'),

      -- ПРОБЛЕМА: Невалидные возрасты
      ('CUST017', 'Андрей', 'Белов', 'andrey.belov@yandex.ru', '+7-925-111-2222', '2023-11-20', '2024-11-18', '5', '14000', '150', 'Тюмень', 'Россия'),
      ('CUST018', 'Светлана', 'Орлова', 'svetlana.orlova@mail.ru', '+7-903-222-3333', '2023-12-01', '2024-12-12', '8', '24000', '5', 'Тольятти', 'Россия'),
      ('CUST019', 'Максим', 'Григорьев', 'maxim.grigoriev@gmail.com', '+7-916-333-4444', '2024-01-10', '2024-11-20', '3', '9500', '-10', 'Ижевск', 'Россия'),

      -- ПРОБЛЕМА: Отрицательные и невалидные числовые значения
      ('CUST020', 'Екатерина', 'Романова', 'ekaterina.romanova@yandex.ru', '+7-925-444-5555', '2024-01-25', '2024-12-03', '-5', '45000', '27', 'Барнаул', 'Россия'),
      ('CUST021', 'Игорь', 'Медведев', 'igor.medvedev@mail.ru', '+7-903-555-6666', '2024-02-05', '2024-11-29', '15', '-8000', '36', 'Владивосток', 'Россия'),

      -- ПРОБЛЕМА: Выбросы (outliers)
      ('CUST022', 'Валентина', 'Соловьева', 'valentina.solovieva@gmail.com', '+7-916-666-7777', '2024-02-15', '2024-12-10', '500', '9999999', '32', 'Иркутск', 'Россия'),
      ('CUST023', 'Николай', 'Зайцев', 'nikolay.zaytsev@yandex.ru', '+7-925-777-8888', '2024-03-01', '2024-11-25', '1', '50', '29', 'Хабаровск', 'Россия'),

      -- ПРОБЛЕМА: Смешанные форматы в одной колонке
      ('CUST024', 'Людмила', 'Федорова', 'ludmila.fedorova@mail.ru', 'восемь девятсот три', '2024-03-10', '2024-12-01', 'десять', 'двадцать тысяч', 'тридцать пять', 'Ульяновск', 'Россия'),

      -- ПРОБЛЕМА: Некорректные страны и города
      ('CUST025', 'Артем', 'Попов', 'artem.popov@gmail.com', '+7-903-888-9999', '2024-03-20', '2024-11-30', '7', '21000', '38', 'Unknown', 'СССР'),
      ('CUST026', 'Марина', 'Егорова', 'marina.egorova@yandex.ru', '+7-916-999-0000', '2024-04-01', '2024-12-05', '4', '13000', '31', '', ''),

      -- Больше нормальных записей для статистики
      ('CUST027', 'Владимир', 'Семенов', 'vladimir.semenov@mail.ru', '+7-925-000-1111', '2024-04-10', '2024-12-12', '19', '56000', '44', 'Челябинск', 'Россия'),
      ('CUST028', 'Ирина', 'Васильева', 'irina.vasilieva@gmail.com', '+7-903-111-2222', '2024-04-20', '2024-11-28', '14', '41000', '33', 'Красноярск', 'Россия'),
      ('CUST029', 'Олег', 'Яковлев', 'oleg.yakovlev@yandex.ru', '+7-916-222-3333', '2024-05-01', '2024-12-08', '25', '85000', '47', 'Ярославль', 'Россия'),
      ('CUST030', 'Галина', 'Макарова', 'galina.makarova@mail.ru', '+7-925-333-4444', '2024-05-10', '2024-11-22', '6', '18000', '29', 'Тула', 'Россия'),

      -- Еще дубликаты с небольшими отличиями (fuzzy duplicates)
      ('CUST031', 'Александр', 'Иванов', 'alex.ivanov@mail.ru', '+7-903-444-5555', '2024-05-15', '2024-12-01', '10', '28000', '35', 'Москва', 'Россия'),
      ('CUST032', 'Александр', 'Иванов', 'alexander.ivanov@mail.ru', '8-903-444-55-55', '2024-05-15', '2024-12-01', '10', '28000', '35', 'Москва', 'РФ'),

      -- Записи с экстремальными значениями
      ('CUST033', 'Вера', 'Королева', 'vera.koroleva@gmail.com', '+7-916-555-6666', '2024-06-01', '2024-12-15', '100', '500000', '55', 'Сочи', 'Россия'),
      ('CUST034', 'Денис', 'Алексеев', 'denis.alekseev@yandex.ru', '+7-925-666-7777', '2024-06-10', '2024-11-20', '1', '100', '21', 'Калининград', 'Россия'),

      -- Записи с недавними датами для проверки фильтров
      ('CUST035', 'Кристина', 'Борисова', 'kristina.borisova@mail.ru', '+7-903-777-8888', '2024-12-01', '2024-12-20', '2', '7500', '26', 'Астрахань', 'Россия'),
      ('CUST036', 'Станислав', 'Титов', 'stanislav.titov@gmail.com', '+7-916-888-9999', '2024-12-05', '2024-12-22', '1', '3500', '32', 'Рязань', 'Россия'),
      ('CUST037', 'Лариса', 'Гусева', 'larisa.guseva@yandex.ru', '+7-925-999-0000', '2024-12-10', '2024-12-24', '3', '9800', '40', 'Киров', 'Россия'),

      -- VIP клиенты (Champions)
      ('CUST038', 'Константин', 'Соловьев', 'konstantin.soloviev@mail.ru', '+7-903-000-1111', '2023-01-05', '2024-12-23', '50', '250000', '48', 'Москва', 'Россия'),
      ('CUST039', 'Анастасия', 'Крылова', 'anastasia.krylova@gmail.com', '+7-916-111-2222', '2023-02-10', '2024-12-22', '45', '220000', '36', 'Санкт-Петербург', 'Россия'),

      -- Lost клиенты (давно не покупали)
      ('CUST040', 'Роман', 'Жуков', 'roman.zhukov@yandex.ru', '+7-925-222-3333', '2022-06-15', '2023-01-20', '20', '65000', '43', 'Нижний Новгород', 'Россия'),
      ('CUST041', 'Валерия', 'Никитина', 'valeria.nikitina@mail.ru', '+7-903-333-4444', '2022-08-20', '2023-03-10', '15', '48000', '31', 'Казань', 'Россия');

EOSQL

fi